name: Static Analysis Firewall

on:
  push:
    branches: [ main, develop, "feature/*" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install -e .
        # Additional static analysis tools
        pip install mypy pyright ruff bandit pre-commit
        
    - name: Install type stubs
      run: |
        pip install types-PyYAML types-requests types-setuptools types-toml
        
    - name: Create stub directories
      run: |
        mkdir -p stubs
        
    - name: Run Ruff linting (TCH and I rules)
      run: |
        ruff check --select=TCH,I --output-format=github .
        
    - name: Run Ruff formatting check
      run: |
        ruff format --check --diff .
        
    - name: Run MyPy strict type checking
      run: |
        mypy --config-file=mypy.ini egw_query_expansion/ src/ scripts/
      continue-on-error: false
      
    - name: Run Pyright type checking
      run: |
        pyright --project=pyproject.toml
      continue-on-error: false
      
    - name: Run Bandit security analysis
      run: |
        bandit -r egw_query_expansion/ src/ scripts/ -f json -o bandit-report.json
        bandit -r egw_query_expansion/ src/ scripts/ -f txt
      continue-on-error: false
      
    - name: Run import validation
      run: |
        python scripts/validate_imports.py
      continue-on-error: false
      
    - name: Run circular import detection
      run: |
        python scripts/detect_circular_imports.py
      continue-on-error: false
      
    - name: Upload Bandit report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-report-${{ matrix.python-version }}
        path: bandit-report.json
        
    - name: Fail on any static analysis violations
      if: failure()
      run: |
        echo "❌ Static analysis violations detected!"
        echo "All static analysis checks must pass before merging."
        exit 1

  dependency-analysis:
    runs-on: ubuntu-latest
    needs: static-analysis
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Install analysis tools
      run: |
        python -m pip install --upgrade pip
        pip install pipdeptree safety pip-audit
        
    - name: Analyze dependency tree
      run: |
        pipdeptree --json-tree > dependency-tree.json
        pipdeptree --graph-output png > dependency-graph.png
        
    - name: Security audit with Safety
      run: |
        safety check --json --output safety-report.json || true
        safety check
        
    - name: Security audit with pip-audit
      run: |
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit
        
    - name: Upload dependency reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-analysis-reports
        path: |
          dependency-tree.json
          dependency-graph.png
          safety-report.json
          pip-audit-report.json

  pre-commit-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit
        
    - name: Cache pre-commit
      uses: actions/cache@v3
      with:
        path: ~/.cache/pre-commit
        key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
        
    - name: Install pre-commit hooks
      run: pre-commit install
      
    - name: Run pre-commit on all files
      run: pre-commit run --all-files --show-diff-on-failure
      
    - name: Validate pre-commit configuration
      run: pre-commit validate-config

  type-coverage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install mypy[reports]
        
    - name: Generate type coverage report
      run: |
        mypy --config-file=mypy.ini --html-report=mypy-reports --txt-report=mypy-reports egw_query_expansion/ src/ scripts/
      continue-on-error: true
      
    - name: Upload type coverage report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: type-coverage-report
        path: mypy-reports/